{% extends "base.html" %}
{% block title %}{{ "Edit" if game else "Add Game" }} — Game Journal{% endblock %}

{% block content %}
<div class="max-w-lg">
  <h1 class="text-2xl font-bold mb-6">{{ "Edit" if game else "Add Game" }}</h1>

  <form method="post"
        action="{{ url_for('playing.edit', game_id=game.id) if game else url_for('playing.add') }}">

    <!-- RAWG search -->
    <div class="mb-5">
      <label class="block text-sm text-gray-400 mb-1">Search RAWG (optional)</label>
      <div class="flex gap-2">
        <input id="rawg-search" type="text" placeholder="Search by title…"
               class="flex-1 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:outline-none focus:border-indigo-500">
        <button type="button" onclick="doSearch()"
                class="px-4 py-2 bg-indigo-700 hover:bg-indigo-600 rounded text-sm transition-colors">
          Search
        </button>
      </div>
      <!-- Results dropdown -->
      <div id="rawg-results" class="hidden mt-1 bg-gray-800 border border-gray-700 rounded divide-y divide-gray-700"></div>
    </div>

    <!-- Cover preview -->
    <div id="cover-preview" class="{{ 'hidden' if not (game and game.cover_url) else '' }} mb-5">
      <img id="cover-img" src="{{ game.cover_url if game and game.cover_url else '' }}"
           alt="Cover art" class="w-24 h-32 object-cover rounded">
    </div>

    <!-- Hidden RAWG metadata -->
    <input type="hidden" name="rawg_id"      id="rawg_id"      value="{{ game.rawg_id or '' if game else '' }}">
    <input type="hidden" name="cover_url"    id="cover_url"    value="{{ game.cover_url or '' if game else '' }}">
    <input type="hidden" name="release_year" id="release_year" value="{{ game.release_year or '' if game else '' }}">
    <input type="hidden" name="genres"       id="genres"       value="{{ game.genres or '' if game else '' }}">
    <input type="hidden" name="platforms"    id="platforms"    value="{{ game.platforms or '' if game else '' }}">

    <!-- Name -->
    <div class="mb-4">
      <label class="block text-sm text-gray-400 mb-1" for="name">Game name <span class="text-red-400">*</span></label>
      <input id="name" name="name" type="text" required
             value="{{ game.name if game else '' }}"
             class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:outline-none focus:border-indigo-500">
    </div>

    <!-- Status -->
    <div class="mb-4">
      <label class="block text-sm text-gray-400 mb-1" for="status">Status</label>
      <select id="status" name="status"
              class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:outline-none focus:border-indigo-500">
        {% for s in statuses %}
          <option value="{{ s }}" {{ 'selected' if game and game.status == s }}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Ratings -->
    <div class="mb-4 flex gap-8">
      <div>
        <label class="block text-sm text-gray-400 mb-2">Enjoyment</label>
        <div class="flex gap-1" id="enjoyment-stars">
          {% for i in range(1, 6) %}
            <button type="button" data-group="enjoyment" data-val="{{ i }}"
                    class="star-btn text-2xl {{ 'text-yellow-400' if game and game.enjoyment and i <= game.enjoyment else 'text-gray-600' }} hover:text-yellow-300 transition-colors">★</button>
          {% endfor %}
        </div>
        <input type="hidden" name="enjoyment" id="enjoyment-val" value="{{ game.enjoyment or '' if game else '' }}">
      </div>
      <div>
        <label class="block text-sm text-gray-400 mb-2">Motivation</label>
        <div class="flex gap-1" id="motivation-stars">
          {% for i in range(1, 6) %}
            <button type="button" data-group="motivation" data-val="{{ i }}"
                    class="star-btn text-2xl {{ 'text-yellow-400' if game and game.motivation and i <= game.motivation else 'text-gray-600' }} hover:text-yellow-300 transition-colors">★</button>
          {% endfor %}
        </div>
        <input type="hidden" name="motivation" id="motivation-val" value="{{ game.motivation or '' if game else '' }}">
      </div>
    </div>

    <!-- Notes -->
    <div class="mb-6">
      <label class="block text-sm text-gray-400 mb-1" for="notes">Notes</label>
      <textarea id="notes" name="notes" rows="4"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:outline-none focus:border-indigo-500 resize-y">{{ game.notes or '' if game else '' }}</textarea>
    </div>

    <div class="flex gap-3">
      <button type="submit"
              class="px-5 py-2 bg-indigo-700 hover:bg-indigo-600 rounded text-sm font-medium transition-colors">
        {{ "Save changes" if game else "Add game" }}
      </button>
      <a href="{{ url_for('playing.index') }}"
         class="px-5 py-2 bg-gray-800 hover:bg-gray-700 rounded text-sm transition-colors">
        Cancel
      </a>
    </div>
  </form>
</div>

<script>
// Star rating buttons
document.querySelectorAll('.star-btn').forEach(function(btn) {
  btn.addEventListener('click', function() {
    var group = this.dataset.group;
    var val   = parseInt(this.dataset.val);
    document.getElementById(group + '-val').value = val;
    document.querySelectorAll('[data-group="' + group + '"]').forEach(function(b) {
      var bVal = parseInt(b.dataset.val);
      b.classList.toggle('text-yellow-400', bVal <= val);
      b.classList.toggle('text-gray-600',   bVal >  val);
    });
  });
});

// RAWG search
function doSearch() {
  var q = document.getElementById('rawg-search').value.trim();
  if (!q) return;
  fetch('/api/games/search?q=' + encodeURIComponent(q))
    .then(function(r) { return r.json(); })
    .then(function(results) {
      var box = document.getElementById('rawg-results');
      box.innerHTML = '';
      if (!results.length) {
        box.innerHTML = '<p class="text-sm text-gray-500 px-3 py-2">No results.</p>';
        box.classList.remove('hidden');
        return;
      }
      results.forEach(function(g) {
        var div = document.createElement('div');
        div.className = 'flex items-center gap-3 px-3 py-2 cursor-pointer hover:bg-gray-700 transition-colors';
        div.innerHTML =
          (g.cover_url ? '<img src="' + g.cover_url + '" class="w-8 h-10 object-cover rounded shrink-0">' : '<div class="w-8 h-10 bg-gray-700 rounded shrink-0"></div>') +
          '<div class="min-w-0"><p class="text-sm font-medium truncate">' + g.name + '</p>' +
          (g.release_year ? '<p class="text-xs text-gray-500">' + g.release_year + '</p>' : '') + '</div>';
        div.addEventListener('click', function() { fillFromRawg(g); });
        box.appendChild(div);
      });
      box.classList.remove('hidden');
    });
}

function fillFromRawg(g) {
  document.getElementById('name').value         = g.name;
  document.getElementById('rawg_id').value      = g.id || '';
  document.getElementById('cover_url').value    = g.cover_url || '';
  document.getElementById('release_year').value = g.release_year || '';
  document.getElementById('genres').value       = g.genres || '';
  document.getElementById('platforms').value    = g.platforms || '';
  if (g.cover_url) {
    document.getElementById('cover-img').src = g.cover_url;
    document.getElementById('cover-preview').classList.remove('hidden');
  }
  document.getElementById('rawg-results').classList.add('hidden');
  document.getElementById('rawg-search').value = '';
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
  if (!e.target.closest('#rawg-results') && !e.target.closest('#rawg-search') && e.target.id !== 'rawg-search-btn') {
    document.getElementById('rawg-results').classList.add('hidden');
  }
});

// Search on Enter key
document.getElementById('rawg-search').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') { e.preventDefault(); doSearch(); }
});
</script>
{% endblock %}
