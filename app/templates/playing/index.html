{% extends "base.html" %}
{% from "macros.html" import stars %}
{% block title %}Playing — Game Journal{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-8">Active Library</h1>

{% macro status_badge(status) %}
  {% if status == "Playing" %}
    <span class="px-2 py-0.5 rounded text-xs font-semibold bg-green-800 text-green-200">Playing</span>
  {% elif status == "On Hold" %}
    <span class="px-2 py-0.5 rounded text-xs font-semibold bg-yellow-800 text-yellow-200">On Hold</span>
  {% elif status == "Dropped" %}
    <span class="px-2 py-0.5 rounded text-xs font-semibold bg-red-900 text-red-300">Dropped</span>
  {% elif status == "Completed" %}
    <span class="px-2 py-0.5 rounded text-xs font-semibold bg-blue-900 text-blue-200">Completed</span>
  {% endif %}
{% endmacro %}

{% macro game_card(game) %}
<div class="bg-gray-900 rounded-xl overflow-hidden flex flex-col shadow-lg">
  <!-- Cover art -->
  <div class="relative w-full aspect-[3/4] bg-gray-800">
    {% if game.cover_url %}
      <img src="{{ game.cover_url }}"
           alt="{{ game.name }} cover"
           class="w-full h-full object-cover">
    {% else %}
      <div class="w-full h-full flex items-center justify-center text-gray-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
    {% endif %}
    <div class="absolute top-2 left-2 flex flex-col gap-1">
      {{ status_badge(game.status) }}
      {% if game.finished %}
        <span class="px-2 py-0.5 rounded text-xs font-semibold bg-purple-900 text-purple-200">Finished ✓</span>
      {% endif %}
    </div>
  </div>

  <!-- Info -->
  <div class="p-4 flex flex-col gap-2 flex-1">
    <div class="flex items-start justify-between gap-1">
      <a href="{{ url_for('playing.detail', game_id=game.id) }}"
         class="font-semibold text-base leading-tight hover:text-indigo-400 transition-colors">
        {{ game.name }}
      </a>
      <a href="{{ url_for('playing.edit', game_id=game.id) }}"
         class="text-xs text-gray-600 hover:text-gray-300 shrink-0 transition-colors">Edit</a>
    </div>
    {% if game.release_year %}
      <p class="text-xs text-gray-500">{{ game.release_year }}</p>
    {% endif %}

    <div class="flex flex-col gap-1 text-xs text-gray-400">
      <div class="flex items-center gap-2">
        <span class="w-16 shrink-0">Enjoyment</span>
        {{ stars(game.enjoyment) }}
      </div>
      <div class="flex items-center gap-2">
        <span class="w-16 shrink-0">Motivation</span>
        {{ stars(game.motivation) }}
      </div>
    </div>

    {% if game.notes %}
      <p class="text-xs text-gray-400 line-clamp-3 mt-1">{{ game.notes }}</p>
    {% endif %}

    {% if game.genres %}
      <p class="text-xs text-gray-600 mt-auto pt-2">{{ game.genres }}</p>
    {% endif %}

    <!-- Check-in button -->
    <div class="mt-2 border-t border-gray-800 pt-2">
      <button type="button"
              class="js-checkin-btn text-xs text-gray-500 hover:text-indigo-400 transition-colors"
              data-action="{{ url_for('playing.checkin', game_id=game.id) }}"
              data-name="{{ game.name }}">
        + Check In
      </button>
    </div>
  </div>
</div>
{% endmacro %}

<!-- Playing now -->
{% if playing %}
<section class="mb-10">
  <h2 class="text-lg font-semibold text-green-400 mb-4">Playing Now</h2>
  <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
    {% for game in playing %}
      {{ game_card(game) }}
    {% endfor %}
  </div>
</section>
{% endif %}

<!-- On Hold -->
{% if on_hold %}
<section>
  <h2 class="text-lg font-semibold text-yellow-400 mb-4">On Hold</h2>
  <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
    {% for game in on_hold %}
      {{ game_card(game) }}
    {% endfor %}
  </div>
</section>
{% endif %}

{% if not playing and not on_hold %}
<p class="text-gray-500">No active games yet.</p>
{% endif %}

<!-- Archived (Dropped / Completed) -->
{% if archived %}
<details class="mt-10">
  <summary class="cursor-pointer text-sm text-gray-500 hover:text-gray-300 transition-colors select-none">
    Archived ({{ archived|length }})
  </summary>
  <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 mt-4">
    {% for game in archived %}
      {{ game_card(game) }}
    {% endfor %}
  </div>
</details>
{% endif %}

<!-- Check-in modal (single shared instance) -->
<div id="checkin-modal"
     class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4"
     onclick="if(event.target===this)closeCheckinModal()">
  <div class="bg-gray-900 rounded-xl p-6 w-full max-w-md shadow-2xl">
    <h2 class="text-lg font-semibold mb-1">Check In</h2>
    <p id="checkin-modal-game" class="text-sm text-gray-400 mb-5"></p>

    <form id="checkin-form" method="post" class="flex flex-col gap-4">

      <!-- Enjoyment -->
      <div>
        <label class="text-xs text-gray-400 block mb-1">Enjoyment</label>
        <div class="flex gap-1" id="modal-enjoyment-stars">
          {% for i in range(1, 6) %}
            <button type="button" data-group="modal-enjoyment" data-val="{{ i }}"
                    class="star-btn text-2xl text-gray-600 hover:text-yellow-300 transition-colors">★</button>
          {% endfor %}
        </div>
        <input type="hidden" name="enjoyment" id="modal-enjoyment-val">
      </div>

      <!-- Motivation -->
      <div>
        <label class="text-xs text-gray-400 block mb-1">Motivation</label>
        <div class="flex gap-1" id="modal-motivation-stars">
          {% for i in range(1, 6) %}
            <button type="button" data-group="modal-motivation" data-val="{{ i }}"
                    class="star-btn text-2xl text-gray-600 hover:text-yellow-300 transition-colors">★</button>
          {% endfor %}
        </div>
        <input type="hidden" name="motivation" id="modal-motivation-val">
      </div>

      <!-- Hours -->
      <div>
        <label class="text-xs text-gray-400 block mb-1">Hours this session</label>
        <input type="number" name="hours_played" id="modal-hours" min="0" max="99" step="0.5"
               class="w-32 bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm focus:outline-none focus:border-indigo-500">
      </div>

      <!-- Status -->
      <div>
        <label class="text-xs text-gray-400 block mb-1">Update status (optional)</label>
        <select name="status" id="modal-status"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm focus:outline-none focus:border-indigo-500">
          <option value="">— no change —</option>
          <option value="Playing">Playing</option>
          <option value="On Hold">On Hold</option>
          <option value="Dropped">Dropped</option>
          <option value="Completed">Completed</option>
        </select>
      </div>

      <!-- Finished checkbox -->
      <div>
        <label class="flex items-center gap-2 cursor-pointer select-none">
          <input type="checkbox" name="finished" value="1" id="modal-finished"
                 class="accent-purple-500 w-4 h-4"
                 onchange="document.getElementById('finish-survey-fields').classList.toggle('hidden', !this.checked)">
          <span class="text-sm text-gray-300">Mark as finished <span class="text-gray-500 text-xs">(still playing)</span></span>
        </label>
      </div>

      <!-- Finish survey (revealed when checkbox is checked) -->
      <div id="finish-survey-fields" class="hidden flex flex-col gap-4 border-t border-gray-800 pt-4">

        <div>
          <label class="text-xs text-gray-400 block mb-1">Overall rating (1–10)</label>
          <div class="flex gap-1">
            {% for i in range(1, 11) %}
              <button type="button" data-group="modal-overall" data-val="{{ i }}"
                      class="star-btn text-xl text-gray-600 hover:text-yellow-300 transition-colors">★</button>
            {% endfor %}
          </div>
          <input type="hidden" name="overall_rating" id="modal-overall-val">
        </div>

        <div>
          <label class="text-xs text-gray-400 block mb-1">Would you play it again?</label>
          <div class="flex gap-4">
            {% for opt in ["Yes", "Maybe", "No"] %}
              <label class="flex items-center gap-1.5 cursor-pointer">
                <input type="radio" name="would_play_again" value="{{ opt }}" class="accent-indigo-500">
                <span class="text-sm">{{ opt }}</span>
              </label>
            {% endfor %}
          </div>
        </div>

        <div class="flex gap-6">
          <div>
            <label class="text-xs text-gray-400 block mb-1">Total hours to finish</label>
            <input type="number" name="hours_to_finish" min="1" max="9999"
                   class="w-28 bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm focus:outline-none focus:border-indigo-500">
          </div>
          <div>
            <label class="text-xs text-gray-400 block mb-1">Difficulty</label>
            <div class="flex gap-1">
              {% for i in range(1, 6) %}
                <button type="button" data-group="modal-difficulty" data-val="{{ i }}"
                        class="star-btn text-xl text-gray-600 hover:text-yellow-300 transition-colors">★</button>
              {% endfor %}
            </div>
            <input type="hidden" name="difficulty" id="modal-difficulty-val">
          </div>
        </div>

      </div>

      <!-- Note -->
      <div>
        <label class="text-xs text-gray-400 block mb-1">Note</label>
        <textarea name="note" id="modal-note" rows="3"
                  class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm focus:outline-none focus:border-indigo-500 resize-y"></textarea>
      </div>

      <div class="flex gap-3 pt-1">
        <button type="submit"
                class="px-5 py-2 bg-indigo-700 hover:bg-indigo-600 rounded text-sm font-medium transition-colors">
          Save check-in
        </button>
        <button type="button" onclick="closeCheckinModal()"
                class="px-5 py-2 bg-gray-800 hover:bg-gray-700 rounded text-sm transition-colors">
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<script>
document.querySelectorAll('.js-checkin-btn').forEach(function(btn) {
  btn.addEventListener('click', function() {
    openCheckinModal(this.dataset.action, this.dataset.name);
  });
});

function openCheckinModal(action, gameName) {
  // Reset form
  document.getElementById('checkin-form').action = action;
  document.getElementById('checkin-modal-game').textContent = gameName;
  document.getElementById('modal-enjoyment-val').value  = '';
  document.getElementById('modal-motivation-val').value = '';
  document.getElementById('modal-hours').value   = '';
  document.getElementById('modal-status').value  = '';
  document.getElementById('modal-note').value    = '';
  document.getElementById('modal-finished').checked = false;
  document.getElementById('finish-survey-fields').classList.add('hidden');
  document.getElementById('modal-overall-val').value    = '';
  document.getElementById('modal-difficulty-val').value = '';
  document.querySelectorAll('input[name="would_play_again"]').forEach(function(r) { r.checked = false; });
  document.querySelector('input[name="hours_to_finish"]').value = '';
  document.querySelectorAll('#checkin-modal .star-btn').forEach(function(b) {
    b.classList.remove('text-yellow-400');
    b.classList.add('text-gray-600');
  });
  document.getElementById('checkin-modal').classList.remove('hidden');
}

function closeCheckinModal() {
  document.getElementById('checkin-modal').classList.add('hidden');
}

</script>

{% endblock %}
