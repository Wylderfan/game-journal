{% extends "base.html" %}
{% from "macros.html" import stars %}
{% block title %}{{ game.name }} — Game Journal{% endblock %}

{% block content %}
<div class="max-w-xl">

  <!-- Back -->
  <a href="{{ url_for('playing.index') }}"
     class="text-sm text-gray-500 hover:text-white transition-colors">← Active Library</a>

  <!-- Header -->
  <div class="flex gap-6 mt-4 mb-8">
    {% if game.cover_url %}
      <img src="{{ game.cover_url }}" alt="{{ game.name }}"
           class="w-28 h-40 object-cover rounded-lg shrink-0">
    {% else %}
      <div class="w-28 h-40 bg-gray-800 rounded-lg shrink-0"></div>
    {% endif %}

    <div class="flex flex-col justify-between py-1">
      <div>
        <div class="flex items-center gap-2 flex-wrap">
          <h1 class="text-2xl font-bold leading-tight">{{ game.name }}</h1>
          {% if game.finished %}
            <span class="px-2 py-0.5 rounded text-xs font-semibold bg-purple-900 text-purple-200">Finished ✓</span>
          {% endif %}
        </div>
        {% if game.release_year %}
          <p class="text-sm text-gray-500 mt-1">{{ game.release_year }}</p>
        {% endif %}
        {% if game.categories %}
          <p class="text-sm text-gray-500">{{ game.categories | map(attribute='name') | join(', ') }}</p>
        {% endif %}
      </div>
      <div class="flex gap-2 flex-wrap mt-2">
        <a href="{{ url_for('playing.edit', pg_id=game.id) }}"
           class="px-4 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-sm transition-colors">
          Edit
        </a>
        {% if not game.finished %}
          <a href="{{ url_for('playing.finish', pg_id=game.id) }}"
             class="px-4 py-1.5 bg-purple-800 hover:bg-purple-700 rounded text-sm transition-colors">
            Mark as Finished
          </a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Status -->
  <section class="bg-gray-900 rounded-xl p-5 mb-4">
    <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Status</h2>
    <form method="post" action="{{ url_for('playing.set_status', pg_id=game.id) }}"
          class="flex flex-wrap gap-2">
      {% for s in statuses %}
        <button name="status" value="{{ s }}" type="submit"
                class="px-4 py-1.5 rounded text-sm font-medium transition-colors
                  {% if game.status == s %}
                    {% if s == 'Playing' %}bg-green-700 text-green-100
                    {% elif s == 'On Hold' %}bg-yellow-700 text-yellow-100
                    {% elif s == 'Dropped' %}bg-red-800 text-red-200
                    {% elif s == 'Completed' %}bg-blue-800 text-blue-200{% endif %}
                  {% else %}
                    bg-gray-800 text-gray-400 hover:bg-gray-700
                  {% endif %}">
          {{ s }}
        </button>
      {% endfor %}
    </form>
  </section>

  <!-- Ratings -->
  <section class="bg-gray-900 rounded-xl p-5 mb-4">
    <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Ratings</h2>
    <div class="flex flex-col gap-3 text-sm">
      <div class="flex items-center gap-3">
        <span class="w-28 text-gray-400">Motivation</span>
        {{ stars(game.hype) }}
        {% if not game.hype %}<span class="text-gray-600 text-xs">unrated</span>{% endif %}
      </div>
      {% if game.estimated_length %}
      <div class="flex items-center gap-3">
        <span class="w-20 text-gray-400">Length</span>
        <span class="text-gray-300">{{ game.estimated_length }}</span>
      </div>
      {% endif %}
      {% if game.series_continuity %}
      <div class="flex items-center gap-3">
        <span class="w-20 text-gray-400">Series</span>
        <span class="text-gray-300">Actively playing through</span>
      </div>
      {% endif %}
      {% set moods = [('mood_chill', 'Chill'), ('mood_intense', 'Intense'), ('mood_story', 'Story'),
                      ('mood_action', 'Action'), ('mood_exploration', 'Exploration')] %}
      {% set has_mood = game.mood_chill or game.mood_intense or game.mood_story or game.mood_action or game.mood_exploration %}
      {% if has_mood %}
      <div>
        <span class="text-gray-400 text-sm">Mood</span>
        <div class="mt-2 flex flex-col gap-1.5">
          {% for field, label in moods %}
            {% set val = game[field] or 0 %}
            {% if val %}
            <div class="flex items-center gap-2 text-xs">
              <span class="w-20 text-gray-500">{{ label }}</span>
              <div class="flex gap-0.5">
                {% for pip in range(1, 6) %}
                  <span class="w-2.5 h-2.5 rounded-sm {{ 'bg-indigo-500' if pip <= val else 'bg-gray-700' }}"></span>
                {% endfor %}
              </div>
            </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
  </section>

  <!-- Notes -->
  {% if game.notes %}
  <section class="bg-gray-900 rounded-xl p-5 mb-4">
    <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Notes</h2>
    <p class="text-sm text-gray-300 whitespace-pre-wrap">{{ game.notes }}</p>
  </section>
  {% endif %}

  <!-- Platforms -->
  {% if game.platforms %}
  <section class="bg-gray-900 rounded-xl p-5 mb-6">
    <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Platforms</h2>
    <p class="text-sm text-gray-400">{{ game.platforms }}</p>
  </section>
  {% endif %}

  <!-- Finished survey summary -->
  {% if game.finished %}
  <section class="bg-gray-900 rounded-xl p-5 mb-4">
    <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Finish Survey</h2>
    <div class="flex flex-col gap-2 text-sm">
      <div class="flex items-center gap-3">
        <span class="w-28 text-gray-400">Overall rating</span>
        {% if game.overall_rating %}
          {{ stars(game.overall_rating, max=10) }}
          <span class="text-gray-500 text-xs">({{ game.overall_rating }}/10)</span>
        {% else %}
          <span class="text-gray-600 text-xs">unrated</span>
        {% endif %}
      </div>
      <div class="flex items-center gap-3">
        <span class="w-28 text-gray-400">Would play again</span>
        <span class="text-gray-300">{{ game.would_play_again or '—' }}</span>
      </div>
      <div class="flex items-center gap-3">
        <span class="w-28 text-gray-400">Hours to finish</span>
        <span class="text-gray-300">{{ game.hours_to_finish ~ 'h' if game.hours_to_finish else '—' }}</span>
      </div>
      <div class="flex items-center gap-3">
        <span class="w-28 text-gray-400">Difficulty</span>
        {% if game.difficulty %}
          {{ stars(game.difficulty) }}
        {% else %}
          <span class="text-gray-600 text-xs">unrated</span>
        {% endif %}
      </div>
    </div>
  </section>
  {% endif %}

  <!-- Check-in history -->
  {% if game.checkins %}
  <section class="bg-gray-900 rounded-xl p-5 mb-4">
    <h2 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">
      Check-ins ({{ game.checkins|length }})
    </h2>
    <div class="flex flex-col divide-y divide-gray-800">
      {% for ci in game.checkins %}
      <div class="py-3 first:pt-0 last:pb-0">
        <div class="flex items-center justify-between gap-2 mb-1">
          <span class="text-xs text-gray-500">{{ ci.created_at.strftime('%b %-d, %Y') }}</span>
          {% if ci.status %}
            <span class="px-1.5 py-0.5 rounded text-xs font-medium
              {% if ci.status == 'Playing' %}bg-green-800 text-green-200
              {% elif ci.status == 'On Hold' %}bg-yellow-800 text-yellow-200
              {% elif ci.status == 'Dropped' %}bg-red-900 text-red-300
              {% elif ci.status == 'Completed' %}bg-blue-900 text-blue-200
              {% else %}bg-gray-700 text-gray-300{% endif %}">
              → {{ ci.status }}
            </span>
          {% endif %}
        </div>
        <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-400 mb-1">
          {% if ci.enjoyment %}
            <span>Enjoyment {{ stars(ci.enjoyment) }}</span>
          {% endif %}
          {% if ci.motivation %}
            <span>Motivation {{ stars(ci.motivation) }}</span>
          {% endif %}
          {% if ci.hours_played %}
            <span>{{ ci.hours_played }}h</span>
          {% endif %}
        </div>
        {% if ci.note %}
          <p class="text-xs text-gray-400 whitespace-pre-wrap">{{ ci.note }}</p>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <!-- Delete -->
  <form method="post" action="{{ url_for('playing.delete', pg_id=game.id) }}"
        onsubmit="return confirm('Remove {{ game.name }}?')">
    <button type="submit"
            class="text-sm text-red-500 hover:text-red-400 transition-colors">
      Remove from library
    </button>
  </form>

</div>
{% endblock %}
