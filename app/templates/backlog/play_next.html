{% extends "base.html" %}
{% block title %}Play Next — Game Journal{% endblock %}

{% block content %}

{# Mood mini-bar macro #}
{% macro mood_bars(game) %}
{% set moods = [
  (game.mood_chill,       'bg-sky-500',    'Chill'),
  (game.mood_intense,     'bg-red-500',    'Intense'),
  (game.mood_story,       'bg-purple-500', 'Story'),
  (game.mood_action,      'bg-orange-500', 'Action'),
  (game.mood_exploration, 'bg-green-500',  'Exploration'),
] %}
{% set has_mood = moods | selectattr(0) | list %}
{% if has_mood %}
<div class="flex items-end gap-0.5 h-4" title="Mood blend">
  {% for val, colour, label in moods %}
    {% set h = ((val or 0) / 5 * 100) | int %}
    <div class="{{ colour }} rounded-sm w-2 opacity-80" style="height: {{ h }}%;" title="{{ label }}: {{ val or 0 }}/5"></div>
  {% endfor %}
</div>
{% endif %}
{% endmacro %}

<div class="flex items-center justify-between mb-2">
  <h1 class="text-2xl font-bold">Play Next</h1>
  <div class="flex gap-3 text-sm">
    <a href="{{ url_for('backlog.add') }}" class="px-4 py-1.5 bg-indigo-700 hover:bg-indigo-600 rounded transition-colors">+ Add game</a>
    <a href="{{ url_for('backlog.index') }}" class="px-4 py-1.5 bg-gray-800 hover:bg-gray-700 rounded transition-colors">Backlog →</a>
  </div>
</div>
<p class="text-xs text-gray-500 mb-6">Ranked by motivation & excitement, series progress, length, category priority, and play status. Change category priority in <a href="{{ url_for('backlog.categories') }}" class="text-indigo-400 hover:underline">Categories</a>.</p>

{% if ranked %}
<ul class="space-y-2">
  {% for game in ranked %}
  <li class="flex items-center gap-3 bg-gray-800 border border-gray-700 rounded-lg px-3 py-2">

    <!-- Rank badge -->
    <span class="text-xs font-mono text-gray-500 w-6 text-center shrink-0">#{{ loop.index }}</span>

    <!-- Cover -->
    {% if game.cover_url %}
      <img src="{{ game.cover_url }}" alt="{{ game.name }}" class="w-8 h-10 object-cover rounded shrink-0">
    {% else %}
      <div class="w-8 h-10 bg-gray-700 rounded shrink-0"></div>
    {% endif %}

    <!-- Name + meta -->
    <div class="flex-1 min-w-0">
      <p class="text-sm font-medium truncate">{{ game.name }}</p>
      <div class="flex items-center flex-wrap gap-2 mt-0.5">
        <!-- Status badge for active games -->
        {% if game.section == 'active' %}
          {% if game.status == 'Playing' %}
            <span class="text-xs font-medium text-green-400 bg-green-900/40 px-1.5 py-0.5 rounded">Playing</span>
          {% elif game.status == 'On Hold' %}
            <span class="text-xs font-medium text-yellow-400 bg-yellow-900/40 px-1.5 py-0.5 rounded">On Hold</span>
          {% endif %}
        {% else %}
          {% for cat in game.categories %}
            <span class="text-xs text-gray-500 bg-gray-700 px-1.5 py-0.5 rounded">{{ cat.name }}</span>
          {% endfor %}
        {% endif %}
        {% if game.estimated_length %}
          <span class="text-xs text-gray-400">{{ game.estimated_length }}</span>
        {% endif %}
        {% if game.series_continuity %}
          <span class="text-xs text-indigo-400 font-medium">Series</span>
        {% endif %}
        <span class="text-xs font-mono text-gray-500 bg-gray-700 px-1.5 py-0.5 rounded" title="Play next score">{{ scores[game.id] }} pts</span>
        {{ mood_bars(game) }}
      </div>
    </div>

    <!-- Action -->
    {% if game.section == 'backlog' %}
    <form method="post" action="{{ url_for('backlog.promote', game_id=game.id) }}" class="shrink-0">
      <button type="submit"
              class="px-3 py-1 text-xs bg-green-800 hover:bg-green-700 rounded transition-colors"
              title="Promote to active library">
        Play
      </button>
    </form>
    {% else %}
    <a href="{{ url_for('playing.detail', game_id=game.id) }}"
       class="px-3 py-1 text-xs bg-gray-700 hover:bg-gray-600 rounded transition-colors shrink-0">
      View
    </a>
    {% endif %}
  </li>
  {% endfor %}
</ul>
{% else %}
<p class="text-gray-500 text-sm">Nothing to show yet. <a href="{{ url_for('backlog.add') }}" class="text-indigo-400 hover:underline">Add a game to the backlog.</a></p>
{% endif %}

{% endblock %}
