{% extends "base.html" %}
{% block title %}Categories — Game Journal{% endblock %}

{% block content %}
<div class="max-w-md">
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-bold">Categories</h1>
    <a href="{{ url_for('backlog.index') }}"
       class="text-sm text-gray-400 hover:text-white transition-colors">← Backlog</a>
  </div>

  <!-- Add category -->
  <form method="post" class="flex gap-2 mb-8">
    <input name="name" type="text" required placeholder="New category name…"
           class="flex-1 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:outline-none focus:border-indigo-500">
    <button type="submit"
            class="px-4 py-2 bg-indigo-700 hover:bg-indigo-600 rounded text-sm transition-colors">
      Add
    </button>
  </form>

  <!-- Existing categories (drag to reorder priority) -->
  {% if categories %}
  <p class="text-xs text-gray-500 mb-3">Drag to set priority — top = most interested in right now. Play Next scoring reflects this order.</p>
  <ul id="cat-list" class="flex flex-col gap-2">
    {% for cat in categories %}
    <li data-id="{{ cat.id }}"
        class="flex items-center gap-3 bg-gray-900 rounded-lg px-4 py-3 cursor-grab active:cursor-grabbing">
      <!-- Drag handle -->
      <span class="text-gray-600 select-none shrink-0">⠿</span>

      <!-- Priority badge -->
      <span class="cat-rank text-xs font-mono text-gray-600 w-4 shrink-0">{{ loop.index }}</span>

      <form method="post" action="{{ url_for('backlog.rename_category', cat_id=cat.id) }}"
            class="flex items-center gap-2 flex-1 min-w-0">
        <input name="name" type="text" value="{{ cat.name }}" required
               class="flex-1 min-w-0 bg-transparent border-b border-gray-700 focus:border-indigo-500 focus:outline-none text-sm font-medium py-0.5">
        <button type="submit"
                class="text-xs text-gray-500 hover:text-white transition-colors shrink-0">
          Rename
        </button>
      </form>
      <span class="text-xs text-gray-500 shrink-0">{{ cat.games | length }} game{{ 's' if cat.games | length != 1 }}</span>
      <form method="post" action="{{ url_for('backlog.delete_category', cat_id=cat.id) }}"
            onsubmit="return confirm('Delete category \'{{ cat.name }}\'? Its games will become uncategorized.')">
        <button type="submit"
                class="text-xs px-2.5 py-1 rounded bg-gray-700 hover:bg-red-900 text-gray-400 hover:text-red-300 transition-colors">
          Delete
        </button>
      </form>
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <p class="text-gray-500 text-sm">No categories yet.</p>
  {% endif %}
</div>

<script>
(function () {
  var list = document.getElementById('cat-list');
  if (!list) return;

  function renumber() {
    list.querySelectorAll('li').forEach(function (li, i) {
      var badge = li.querySelector('.cat-rank');
      if (badge) badge.textContent = i + 1;
    });
  }

  new Sortable(list, {
    animation: 150,
    ghostClass: 'opacity-40',
    onEnd: function () {
      renumber();
      var ids = Array.from(list.querySelectorAll('li')).map(function (li) {
        return parseInt(li.dataset.id);
      });
      fetch('{{ url_for("backlog.categories_reorder") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(ids),
      });
    },
  });
})();
</script>
{% endblock %}
